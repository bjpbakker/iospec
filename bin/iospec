#!/usr/bin/env io

safeLoadIoSpec := method(
  initializationError := try (
    doRelativeFile("../src/iospec/iospec.io")
  )
  if (initializationError,
    write("IoSpec cannot load. Please check your installation.\n",
          "\n",
          "Details of the initialization failure are printed below.\n")
    initializationError showStack
    System exit(1)
  )
)

safeLoadIoSpec

App := Object clone do (
  run := method(argv,
    if (argv size == 0,
      argv := list(".")
    )

    files := loadFiles(argv map(arg, SpecFilesArgument with(arg)))
    if (files isEmpty,
      error("No specs to run")
    )
    files foreach(file, Lobby doFile(file))
    result := Runner clone setWorld(IoSpec world) setReport(IoSpec report) run
    result allPassed or error
  )

  loadFiles := method(args,
    args map(arg, FileCollector clone setDirectory(arg root) collect(arg fnpattern)) flatten
  )

  error := method(msg,
    msg and writeln(msg)
    System exit(1)
  )
)

App run(System args slice(1))

